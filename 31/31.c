#define F_CPU 8000000UL

#include <avr/io.h>
#include <avr/interrupt.h>

// Инициализация внешних прерываний на порту D
void initialize_PCINT() {
    sei(); // Разрешить глобальные прерывания

    // Разрешить прерывания PCINT2 (порт D: PD7..PD0)
    PCICR |= (1 << PCIE2);

    // Активировать прерывания для всех пинов порта D
    PCMSK2 = 0xFF; // Установить все биты в 1 (0b11111111)
}

// Инициализация портов и подтягивающих резисторов
void initialize_ports() {
    // Настройка порта B как выходного для управления семисегментным индикатором
    DDRB = 0xFF; // Все пины порта B выходы (0b11111111)

    // Настройка порта D как входного для считывания кнопок
    DDRD = 0x00; // Все пины порта D входы (0b00000000)

    /* Подключение подтягивающих резисторов:
       - Для PD7..PD4 включаем внутренние подтягивающие резисторы (лог. 1).
       - Для PD3..PD0 резисторы подключены внешне. */
    PORTD = 0b11110000;
}

int main() {
    initialize_ports();
    initialize_PCINT();

    while (1) {
        // Основной цикл ничего не делает, всё обрабатывается в прерывании
    }
}

// Обработчик прерываний по изменению состояния на входах порта D (PCINT2)
ISR(PCINT2_vect) {
    uint8_t pin;
    for (pin = 0; pin < 8; ++pin) {
        // Проверяем состояние кнопки на пине PDx
        if ((PIND >> pin) & 1) {
            // Если кнопка НЕ нажата (лог. 1), выключаем соответствующий сегмент
            PORTB &= ~(1 << pin);
        } else {
            // Если кнопка нажата (лог. 0), включаем соответствующий сегмент
            PORTB |= (1 << pin);
        }
    }
}
