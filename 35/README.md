# Объяснение кода: Устройство «бегущий огонь» с использованием таймера в режиме CTC

Этот код реализует устройство "бегущий огонь", которое включает светодиоды поочередно с использованием таймера в режиме CTC. Задержка между переключениями определяется прерыванием таймера.

---

## Основные параметры

1. **Частота микроконтроллера**: `F_CPU = 8 МГц`.
2. **Режим работы таймера**: CTC (Clear Timer on Compare Match).
3. **Предделитель таймера**: `TIMER_PRESCALER = 1024`.
4. **Задержка между переключениями**: ~300 мс (определяется через `TIMER_TOP_VALUE`).

---

## Настройка портов

### Функция `init_led_ports`

```c
void init_led_ports() {
    LED_DDR_B = 0xFF; // Все пины PORTB как выходы
    LED_DDR_C = 0x03; // Пины PC0 и PC1 как выходы
    LED_PORT_B = 0x00; // Выключить все светодиоды на PORTB
    LED_PORT_C = 0x00; // Выключить все светодиоды на PORTC
}
```

1. **`PORTB`**:
    - Используется для управления 8 светодиодами.
    - Все пины настроены как выходы.

2. **`PORTC`**:
    - Используется для управления 2 светодиодами (`PC0`, `PC1`).
    - Эти пины также настроены как выходы.

3. **Начальное состояние**:
    - Все светодиоды выключены (`0x00`).

---

## Настройка таймера

### Функция `init_timer_ctc`

```c
void init_timer_ctc() {
    TCCR0A = 0x00; // Очистка регистра TCCR0A
    TCCR0B = (1 << WGM02) | (1 << CS02) | (1 << CS00); // Режим CTC, предделитель 1024
    OCR0A = TIMER_TOP_VALUE; // Установка значения сравнения
    TIMSK0 = (1 << OCIE0A); // Включение прерывания по совпадению
    sei(); // Включение глобальных прерываний
}
```

1. **`TCCR0A` и `TCCR0B`**:
    - Настройка режима CTC (Clear Timer on Compare Match).
    - Предделитель установлен в 1024 для увеличения времени счета.

2. **`OCR0A`**:
    - Определяет значение, при достижении которого таймер срабатывает.
    - `TIMER_TOP_VALUE = 233` рассчитан для задержки ~300 мс:  
      TIMER_TOP_VALUE = F_CPU / (PRESCALER * TARGET_FREQUENCY) - 1 = 8000000 / (1024 * 4) - 1 ≈ 233.

3. **`TIMSK0`**:
    - Включает прерывание по совпадению таймера (`OCIE0A`).

4. **`sei()`**:
    - Разрешает обработку глобальных прерываний.

---

## Обработчик прерывания

### ISR `TIMER0_COMPA_vect`

```c
ISR(TIMER0_COMPA_vect) {
    LED_PORT_B = 0x00; // Выключаем все светодиоды на PORTB
    LED_PORT_C = 0x00; // Выключаем все светодиоды на PORTC

    if (current_led < 8) {
        LED_PORT_B = (1 << current_led); // Включаем светодиод на PORTB
    } else {
        LED_PORT_C = (1 << (current_led - 8)); // Включаем светодиод на PORTC
    }

    current_led = (current_led + 1) % 10; // Переход к следующему светодиоду
}
```

1. **Отключение всех светодиодов**:
    - Перед включением следующего светодиода текущие отключаются.

2. **Включение светодиода**:
    - Светодиоды на `PORTB` активируются, если `current_led < 8`.
    - Светодиоды на `PORTC` активируются, если `current_led >= 8`.

3. **Цикличное переключение**:
    - После 10-го светодиода счетчик возвращается к 0 (`current_led = (current_led + 1) % 10`).

---

## Основной цикл

### Функция `main`

```c
int main() {
    init_led_ports();  // Инициализация портов
    init_timer_ctc();  // Инициализация таймера
    while (1);         // Бесконечный цикл
}
```

- Основной цикл пуст, так как управление полностью реализовано через прерывания.

---

## Итоговая схема работы

1. **Настройка таймера**:
    - Таймер работает в режиме CTC с предделителем 1024.
    - Таймер генерирует прерывание каждые 300 мс.

2. **Прерывание таймера**:
    - При срабатывании прерывания включается следующий светодиод.
    - После 10-го светодиода цикл начинается заново.

3. **Управление светодиодами**:
    - Светодиоды на `PORTB` управляют первыми 8 светодиодами.
    - Светодиоды на `PORTC` управляют последними 2 светодиодами.

---

## Примечания

- **Частота переключения**: Частота переключений рассчитывается как 1 / (TIMER_TOP_VALUE + 1) * PRESCALER / F_CPU. В данном случае она равна ~300 мс.
- **Применение**: Такой "бегущий огонь" часто используется для индикаторов состояния, визуальных эффектов или тестирования светодиодов.